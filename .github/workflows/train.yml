name: Train and Deploy (CI/CD)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create output directory
        run: mkdir -p output

      - name: Train model
        run: |
          python train.py

      - name: Log metrics
        run: |
          python - << 'PY'
          import json
          m = json.load(open("output/results.json"))
          print("metrics:", m)
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: output/

  deploy:
    runs-on: ubuntu-latest
    needs: train

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: .

      - name: Install Python deps for deploy
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Compare metrics with baseline
        id: gate
        run: |
          python - << 'PY'
          import json, os

          m = json.load(open("output/results.json"))

          # NOTE: keys must match train.py (case-sensitive)
          cur_r2  = float(m["R2"])
          cur_mse = float(m["MSE"])

          best_r2  = float(os.environ["BEST_R2"])
          best_mse = float(os.environ["BEST_MSE"])

          improved = (cur_r2 > best_r2) and (cur_mse < best_mse)

          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"improved={'true' if improved else 'false'}\n")
              out.write(f"cur_r2={cur_r2}\n")
              out.write(f"cur_mse={cur_mse}\n")

          print("Current:", cur_r2, cur_mse)
          print("Best:   ", best_r2, best_mse)
          print("Improved?", improved)
          PY
        env:
          BEST_R2: ${{ vars.BEST_R2 }}
          BEST_MSE: ${{ vars.BEST_MSE }}

      - name: Stop if not improved
        if: steps.gate.outputs.improved != 'true'
        run: |
          echo "2022BCS0205 ---- Metric did not improve"
          exit 0

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            srideekshaa/wine_predict_2022bcs0205:latest
            srideekshaa/wine_predict_2022bcs0205:${{ github.sha }}

      - name: Update BEST_R2 and BEST_MSE
        run: |
          python - << 'PY'
          import os, requests

          owner, repo = os.environ["GITHUB_REPOSITORY"].split("/")
          token = os.environ["GH_PAT"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          def patch(name, value):
              url = f"https://api.github.com/repos/{owner}/{repo}/actions/variables/{name}"
              r = requests.patch(url, headers=headers, json={"name": name, "value": str(value)})
              if r.status_code not in (200, 201, 204):
                  raise SystemExit(r.text)
              print("Updated", name, value)

          patch("BEST_R2", os.environ["CUR_R2"])
          patch("BEST_MSE", os.environ["CUR_MSE"])
          PY
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          CUR_R2: ${{ steps.gate.outputs.cur_r2 }}
          CUR_MSE: ${{ steps.gate.outputs.cur_mse }}
